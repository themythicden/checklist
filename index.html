<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Journey Together Checklist</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .saving-indicator {
      transition: opacity 0.3s ease;
    }
    .sticky-header {
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
      padding: 1rem 0;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-4xl mx-auto p-4">
    <div class="sticky-header">
      <h1 class="text-2xl font-bold mb-2">Journey Together Set Checklist</h1>
      <div class="flex flex-wrap items-center gap-4 mb-4">
        <label for="sort" class="font-semibold">Sort by:</label>
        <select id="sort" class="border p-1 rounded">
          <option value="number">Card Number (asc)</option>
          <option value="name">Name (A-Z)</option>
          <option value="rarity">Rarity</option>
        </select>

        <label class="flex items-center gap-2">
          <input type="checkbox" id="hideCompleted" />
          Hide completed cards
        </label>

        <div class="flex gap-2 items-center">
          <label><input type="radio" name="setMode" value="base" checked /> Base Set</label>
          <label><input type="radio" name="setMode" value="parallel" /> Parallel Set</label>
          <label><input type="radio" name="setMode" value="master" /> Master Set</label>
        </div>

        <div id="progress" class="text-sm font-semibold text-green-600 ml-auto"></div>

        <span id="savingIndicator" class="saving-indicator text-sm text-blue-600 hidden">Saving...</span>
      </div>
    </div>

    <div id="checklist" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
  </div>

  <script>
    const API_URL = '/.netlify/functions/fetch-checklist';
    const SAVE_URL = '/.netlify/functions/save-checklist';
    const checklistContainer = document.getElementById('checklist');
    const savingIndicator = document.getElementById('savingIndicator');
    const progress = document.getElementById('progress');

    const CARD_TOTALS = {
      base: 159,
      master: 190,
      parallel: 159,
    };

    let cardData = [];

    async function fetchChecklist() {
      const res = await fetch(API_URL);
      const data = await res.json();
      cardData = data;
      renderChecklist(data);
    }

    function renderChecklist(cards) {
      const hideCompleted = document.getElementById('hideCompleted').checked;
      const mode = document.querySelector('input[name="setMode"]:checked').value;
      checklistContainer.innerHTML = '';

      let collected = 0;
      const filteredCards = cards.filter(card => {
        const saved = JSON.parse(localStorage.getItem(card.name)) || {};
        const standard = saved.standard ?? card.standard;
        const reverseHolo = saved.reverseHolo ?? card.reverseHolo;

        if (hideCompleted && standard && (card.hasReverseHolo ? reverseHolo : true)) {
          return false;
        }

        if (mode === 'base') return true;
        if (mode === 'parallel') return card.hasReverseHolo;
        if (mode === 'master') return true;
        return true;
      });

      filteredCards.forEach(card => {
        const saved = JSON.parse(localStorage.getItem(card.name)) || {};
        const standard = saved.standard ?? card.standard;
        const reverseHolo = saved.reverseHolo ?? card.reverseHolo;

        if ((mode === 'base' && standard) ||
            (mode === 'parallel' && (standard || reverseHolo)) ||
            (mode === 'master' && (standard || reverseHolo))) {
          collected++;
        }

        const div = document.createElement('div');
        div.className = 'bg-white rounded-xl shadow p-4 flex gap-4 items-start';

        const img = document.createElement('img');
        img.src = `https://images.pokemontcg.io/sv9/${card.number}.png`;
        img.alt = card.name;
        img.className = 'w-24 h-auto rounded';

        let reverseCheckbox = '';
        if (card.hasReverseHolo === true) {
          reverseCheckbox = `
            <label class="flex items-center gap-1">
              <input type="checkbox" ${reverseHolo ? 'checked' : ''} data-name="${card.name}" data-type="reverseHolo"> Reverse Holo
            </label>
          `;
        }

        const content = document.createElement('div');
        content.innerHTML = `
          <h2 class="text-lg font-bold mb-1">${card.name}</h2>
          <p class="text-sm text-gray-500">#${card.number} - ${card.rarity}</p>
          <div class="mt-2 flex gap-4 items-center">
            <label class="flex items-center gap-1">
              <input type="checkbox" ${standard ? 'checked' : ''} data-name="${card.name}" data-type="standard"> Standard
            </label>
            ${reverseCheckbox}
          </div>
        `;

        div.appendChild(img);
        div.appendChild(content);
        checklistContainer.appendChild(div);
      });

      progress.textContent = `${collected} / ${CARD_TOTALS[mode]} collected`;

      document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', handleCheckboxChange);
      });
    }

    function showSaving(show) {
      savingIndicator.classList.toggle('hidden', !show);
    }

    async function handleCheckboxChange(e) {
      const checkbox = e.target;
      const name = checkbox.dataset.name;
      const type = checkbox.dataset.type;
      const card = cardData.find(c => c.name === name);

      const updated = {
        name: card.name,
        number: card.number,
        rarity: card.rarity,
        hasReverseHolo: card.hasReverseHolo,
        standard: type === 'standard' ? checkbox.checked : document.querySelector(`input[data-name="${name}"][data-type="standard"]`)?.checked || false,
        reverseHolo: type === 'reverseHolo' ? checkbox.checked : document.querySelector(`input[data-name="${name}"][data-type="reverseHolo"]`)?.checked || false
      };

      localStorage.setItem(name, JSON.stringify(updated));
      showSaving(true);

      try {
        await fetch(SAVE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updated)
        });
      } catch (err) {
        alert('Failed to save to Google Sheets.');
        console.error(err);
      } finally {
        showSaving(false);
        renderChecklist(cardData); // update filtered view
      }
    }

    document.getElementById('sort').addEventListener('change', e => {
      const sortBy = e.target.value;
      const sorted = [...cardData];
      if (sortBy === 'number') {
        sorted.sort((a, b) => parseInt(a.number) - parseInt(b.number));
      } else if (sortBy === 'name') {
        sorted.sort((a, b) => a.name.localeCompare(b.name));
      } else if (sortBy === 'rarity') {
        sorted.sort((a, b) => a.rarity.localeCompare(b.rarity));
      }
      renderChecklist(sorted);
    });

    document.getElementById('hideCompleted').addEventListener('change', () => renderChecklist(cardData));
    document.querySelectorAll('input[name="setMode"]').forEach(rb => rb.addEventListener('change', () => renderChecklist(cardData)));

    fetchChecklist();
  </script>
</body>
</html>
