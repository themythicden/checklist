<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pokémon Card Checklist</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #rarityDropdown:hover #rarityMenu {
      display: block;
    }
    #rarityMenu {
      display: none;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="sticky top-0 z-10 bg-white shadow p-4 space-y-2">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <img id="setLogo" class="h-12" alt="Set Logo">
      </div>
      <span id="progressText" class="text-sm font-medium text-blue-600"></span>
    </div>

    <div class="flex flex-wrap items-center gap-4 mt-2">
      <label>
        Set:
        <select id="setSelector" class="border p-1 rounded">
          <option value="JourneyTogether">Journey Together</option>
          <option value="TemporalForces">Temporal Forces</option>
          <option value="ObsidianFlames">Obsidian Flames</option>
          <option value="PrismaticEvolutions">Prismatic Evolutions</option>
        </select>
      </label>

      <label><input type="radio" name="mode" value="base" checked> Base Set</label>
      <label><input type="radio" name="mode" value="parallel"> Parallel Set</label>
      <label><input type="radio" name="mode" value="master"> Master Set</label>

      <div id="rarityDropdown" class="relative">
        <button class="border px-2 py-1 rounded">Filter Rarity ⌄</button>
        <div id="rarityMenu" class="absolute mt-1 bg-white border rounded shadow p-2 z-50 max-h-48 overflow-y-auto">
          <div id="rarityFilters" class="flex flex-col gap-1 text-sm"></div>
        </div>
      </div>

      <label>
        Sort by:
        <select id="sort" class="border p-1 rounded">
          <option value="number">Card Number</option>
          <option value="name">Name</option>
          <option value="rarity">Rarity</option>
        </select>
      </label>

      <label><input type="checkbox" id="hideCompleted"> Hide Collected</label>
      <span id="savingIndicator" class="text-sm text-blue-500 hidden">Saving...</span>
      <span id="loadingIndicator" class="text-sm text-gray-500 hidden">Loading...</span>
    </div>
  </div>

  <div id="checklist" class="grid grid-cols-1 sm:grid-cols-2 gap-4 p-4"></div>

  <script>
    const BASE_COUNTS = {
      JourneyTogether: 159,
      TemporalForces: 162,
      ObsidianFlames: 197,
      PrismaticEvolutions: 165
    };
    const MASTER_COUNTS = {
      JourneyTogether: 190,
      TemporalForces: 218,
      ObsidianFlames: 230,
      PrismaticEvolutions: 200
    };
    const SET_LOGOS = {
      JourneyTogether: 'https://images.pokemontcg.io/sv9/logo.png',
      TemporalForces: 'https://images.pokemontcg.io/sv5/logo.png',
      ObsidianFlames: 'https://images.pokemontcg.io/sv3pt5/logo.png',
      PrismaticEvolutions: 'https://images.pokemontcg.io/sv4/logo.png'
    };

    const checklistContainer = document.getElementById('checklist');
    const savingIndicator = document.getElementById('savingIndicator');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const progressText = document.getElementById('progressText');
    const setSelector = document.getElementById('setSelector');
    const sortDropdown = document.getElementById('sort');
    const hideCompletedCheckbox = document.getElementById('hideCompleted');
    const rarityFiltersContainer = document.getElementById('rarityFilters');
    const setLogo = document.getElementById('setLogo');

    let allCards = [];
    let selectedMode = 'base';
    let currentSet = localStorage.getItem('selectedSet') || setSelector.value;

    function getSetCode(setName) {
      return {
        JourneyTogether: 'sv9',
        TemporalForces: 'sv5',
        ObsidianFlames: 'sv3pt5',
        PrismaticEvolutions: 'sv4'
      }[setName] || 'sv9';
    }

    function getApiUrl(set) {
      return `/.netlify/functions/fetch-checklist?set=${set}`;
    }

    function buildRarityFilters(cards) {
      const rarities = [...new Set(cards.map(c => c.rarity).filter(Boolean))].sort();
      rarityFiltersContainer.innerHTML = '';
      rarities.forEach(r => {
        const id = `rarity-${r.replace(/\s/g, '')}`;
        rarityFiltersContainer.innerHTML += `
          <label><input type="checkbox" id="${id}" value="${r}" checked> ${r}</label>
        `;
      });
    }

    function showSaving(show) {
      savingIndicator.classList.toggle('hidden', !show);
    }
    function showLoading(show) {
      loadingIndicator.classList.toggle('hidden', !show);
    }

    async function fetchChecklist(set = currentSet) {
      currentSet = set;
      localStorage.setItem('selectedSet', set);
      setLogo.src = SET_LOGOS[set] || '';
      showLoading(true);
      try {
        const res = await fetch(getApiUrl(set));
        const data = await res.json();
        data.forEach(card => card.setCode = getSetCode(set));
        allCards = data;
        buildRarityFilters(data);
        renderChecklist();
      } catch (err) {
        console.error('Failed to fetch checklist:', err);
      } finally {
        showLoading(false);
      }
    }

    function getFilteredCards() {
      const selectedRarities = Array.from(rarityFiltersContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
      const hideCompleted = hideCompletedCheckbox.checked;
      const baseCount = BASE_COUNTS[currentSet];

      return allCards.filter(card => {
        const saved = JSON.parse(localStorage.getItem(card.name)) || {};
        const variantKeys = Object.keys(card).filter(k => !['name', 'number', 'rarity', 'hasReverseHolo', 'setCode'].includes(k) && typeof card[k] === 'boolean');
        const isCompleted = variantKeys.every(k => saved[k] || card[k]);

        if (selectedMode === 'base' && parseInt(card.number) > baseCount) return false;
        if (hideCompleted && isCompleted) return false;
        return selectedRarities.includes(card.rarity);
      });
    }

    function renderChecklist() {
      const cards = getFilteredCards();
      const sortBy = sortDropdown.value;
      const sorted = [...cards].sort((a, b) => {
        if (sortBy === 'number') return parseInt(a.number) - parseInt(b.number);
        if (sortBy === 'name') return a.name.localeCompare(b.name);
        if (sortBy === 'rarity') return a.rarity.localeCompare(b.rarity);
        return 0;
      });

      checklistContainer.innerHTML = '';
      let collected = 0;
      const baseCount = BASE_COUNTS[currentSet];
      const masterCount = MASTER_COUNTS[currentSet];

      sorted.forEach(card => {
        const saved = JSON.parse(localStorage.getItem(card.name)) || {};
        const number = parseInt(card.number);
        if (number > masterCount) return;

        const variantKeys = Object.keys(card).filter(k => !['name', 'number', 'rarity', 'hasReverseHolo', 'setCode'].includes(k) && typeof card[k] === 'boolean');
        const checkedCount = variantKeys.filter(k => saved[k] || card[k]).length;

        let countThis = false;
        if (selectedMode === 'base' && saved.standard) countThis = true;
        else if (selectedMode === 'parallel' && (saved.standard || saved.reverseHolo)) countThis = true;
        else if (selectedMode === 'master' && checkedCount) countThis = true;

        if (countThis) collected++;

        const checkboxGroup = variantKeys.map(variant => {
          if (selectedMode === 'base' && variant !== 'standard') return '';
          const checked = saved[variant] ?? card[variant];
          return `
            <label class="flex items-center gap-1">
              <input type="checkbox" data-name="${card.name}" data-type="${variant}" ${checked ? 'checked' : ''}> ${variant.replace(/([A-Z])/g, ' $1')}
            </label>
          `;
        }).join('');

        const div = document.createElement('div');
        div.className = 'bg-white p-4 rounded-xl shadow flex gap-4';

        const img = document.createElement('img');
        img.src = `https://images.pokemontcg.io/${card.setCode}/${card.number}.png`;
        img.alt = card.name;
        img.className = 'w-24 h-auto';

        const content = document.createElement('div');
        content.innerHTML = `
          <h2 class="font-bold text-lg">${card.name}</h2>
          <p class="text-sm text-gray-500">#${card.number} - ${card.rarity}</p>
          <div class="flex flex-wrap gap-4 mt-2">${checkboxGroup}</div>
        `;

        div.appendChild(img);
        div.appendChild(content);
        checklistContainer.appendChild(div);
      });

      const totalCount = selectedMode === 'base' ? baseCount : selectedMode === 'parallel' ? baseCount : masterCount;
      progressText.textContent = `${collected} / ${totalCount}`;

      document.querySelectorAll('input[type="checkbox"]').forEach(cb =>
        cb.addEventListener('change', handleCheckboxChange)
      );
    }

    async function handleCheckboxChange(e) {
      const cb = e.target;
      const name = cb.dataset.name;
      const type = cb.dataset.type;
      const card = allCards.find(c => c.name === name);
      const saved = JSON.parse(localStorage.getItem(name)) || {};
      saved[type] = cb.checked;

      const updated = {
        name: card.name,
        number: card.number,
        rarity: card.rarity,
        ...card,
        ...saved
      };

      localStorage.setItem(name, JSON.stringify(saved));
      showSaving(true);

      try {
        await fetch('/.netlify/functions/save-checklist', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updated)
        });
      } catch (err) {
        console.error('Save error:', err);
        alert('Failed to save to Google Sheets.');
      } finally {
        showSaving(false);
        renderChecklist();
      }
    }

    setSelector.addEventListener('change', () => fetchChecklist(setSelector.value));
    sortDropdown.addEventListener('change', renderChecklist);
    hideCompletedCheckbox.addEventListener('change', renderChecklist);
    document.querySelectorAll('input[name="mode"]').forEach(rb =>
      rb.addEventListener('change', (e) => {
        selectedMode = e.target.value;
        renderChecklist();
      })
    );
    rarityFiltersContainer.addEventListener('change', renderChecklist);

    fetchChecklist(currentSet);
  </script>
</body>
</html>
