<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pokémon Card Checklist</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .dropdown-content {
      display: none;
    }
    .dropdown:hover .dropdown-content {
      display: block;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="sticky top-0 z-10 bg-white shadow p-4 space-y-2">
    <h1 class="text-2xl font-bold">Pokémon Card Checklist</h1>

    <div class="flex flex-wrap items-center gap-4">
      <!-- Set Selector -->
      <label>
        Set:
        <select id="setSelector" class="border p-1 rounded">
          <option value="JourneyTogether">Journey Together</option>
          <option value="TemporalForces">Temporal Forces</option>
          <option value="ObsidianFlames">Obsidian Flames</option>
        </select>
      </label>

      <!-- Toggle Base/Parallel/Master -->
      <label><input type="radio" name="mode" value="base" checked> Base Set</label>
      <label><input type="radio" name="mode" value="parallel"> Parallel Set</label>
      <label><input type="radio" name="mode" value="master"> Master Set</label>

      <!-- Rarity Filter Dropdown -->
      <div class="relative dropdown">
        <button class="border px-3 py-1 rounded bg-white shadow">Rarity ▼</button>
        <div id="rarityFilters" class="dropdown-content absolute bg-white shadow rounded p-2 z-20 w-40 max-h-60 overflow-y-auto mt-1"></div>
      </div>

      <!-- Sorting -->
      <label>
        Sort by:
        <select id="sort" class="border p-1 rounded">
          <option value="number">Card Number</option>
          <option value="name">Name</option>
          <option value="rarity">Rarity</option>
        </select>
      </label>

      <label><input type="checkbox" id="hideCompleted"> Hide Collected</label>

      <!-- Progress -->
      <span id="progressText" class="text-sm font-medium text-blue-600 ml-auto"></span>

      <!-- Saving / Loading Indicator -->
      <span id="savingIndicator" class="text-sm text-blue-500 hidden">Saving...</span>
      <span id="loadingIndicator" class="text-sm text-gray-500 hidden">Loading...</span>
    </div>
  </div>

  <div id="checklist" class="grid grid-cols-1 sm:grid-cols-2 gap-4 p-4"></div>

  <script>
    const BASE_COUNTS = {
      JourneyTogether: 159,
      TemporalForces: 162,
      ObsidianFlames: 197
    };
    const MASTER_COUNTS = {
      JourneyTogether: 190,
      TemporalForces: 218,
      ObsidianFlames: 230
    };

    const checklistContainer = document.getElementById('checklist');
    const savingIndicator = document.getElementById('savingIndicator');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const progressText = document.getElementById('progressText');
    const setSelector = document.getElementById('setSelector');
    const sortDropdown = document.getElementById('sort');
    const hideCompletedCheckbox = document.getElementById('hideCompleted');
    const rarityFiltersContainer = document.getElementById('rarityFilters');

    let allCards = [];
    let currentSet = localStorage.getItem('selectedSet') || setSelector.value;
    setSelector.value = currentSet;
    let selectedMode = 'base';

    function getApiUrl(set) {
      return `/.netlify/functions/fetch-checklist?set=${set}`;
    }

    function buildRarityFilters(cards) {
      const rarities = [...new Set(cards.map(c => c.rarity).filter(Boolean))].sort();
      rarityFiltersContainer.innerHTML = '';
      rarities.forEach(r => {
        const id = `rarity-${r.replace(/\s/g, '')}`;
        rarityFiltersContainer.innerHTML += `
          <label class="block text-sm">
            <input type="checkbox" id="${id}" value="${r}" checked class="mr-1"> ${r}
          </label>
        `;
      });
    }

    function showSaving(show) {
      savingIndicator.classList.toggle('hidden', !show);
    }

    function showLoading(show) {
      loadingIndicator.classList.toggle('hidden', !show);
    }

    function getFilteredCards() {
      const selectedRarities = Array.from(rarityFiltersContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
      const hideCompleted = hideCompletedCheckbox.checked;
      const baseCount = BASE_COUNTS[currentSet];

      return allCards.filter(card => {
        const saved = JSON.parse(localStorage.getItem(card.name)) || {};
        const standard = saved.standard ?? card.standard;
        const reverseHolo = saved.reverseHolo ?? card.reverseHolo;

        if (selectedMode === 'base' && parseInt(card.number) > baseCount) return false;
        if (hideCompleted && standard && (card.hasReverseHolo ? reverseHolo : true)) return false;
        return selectedRarities.includes(card.rarity);
      });
    }

    function renderChecklist() {
      const cards = getFilteredCards();
      const sorted = [...cards];
      const sortBy = sortDropdown.value;
      if (sortBy === 'number') sorted.sort((a, b) => parseInt(a.number) - parseInt(b.number));
      if (sortBy === 'name') sorted.sort((a, b) => a.name.localeCompare(b.name));
      if (sortBy === 'rarity') sorted.sort((a, b) => a.rarity.localeCompare(b.rarity));

      checklistContainer.innerHTML = '';
      let collected = 0;
      const baseCount = BASE_COUNTS[currentSet];
      const masterCount = MASTER_COUNTS[currentSet];

      allCards.forEach(card => {
        const saved = JSON.parse(localStorage.getItem(card.name)) || {};
        const standard = saved.standard ?? card.standard;
        const reverseHolo = saved.reverseHolo ?? card.reverseHolo;

        if (parseInt(card.number) > masterCount) return;

        if (selectedMode === 'base' && standard) collected++;
        if (selectedMode === 'parallel' && (standard || reverseHolo)) collected++;
        if (selectedMode === 'master') collected += (standard ? 1 : 0) + (reverseHolo ? 1 : 0);
      });

      const totalCount = selectedMode === 'base' ? baseCount : selectedMode === 'parallel' ? baseCount * 2 : masterCount * 2;
      progressText.textContent = `${collected} / ${totalCount}`;

      sorted.forEach(card => {
        const saved = JSON.parse(localStorage.getItem(card.name)) || {};
        const standard = saved.standard ?? card.standard;
        const reverseHolo = saved.reverseHolo ?? card.reverseHolo;

        const div = document.createElement('div');
        div.className = 'bg-white p-4 rounded-xl shadow flex gap-4';

        const img = document.createElement('img');
        img.src = `https://images.pokemontcg.io/sv9/${card.number}.png`;
        img.alt = card.name;
        img.className = 'w-24 h-auto';

        const content = document.createElement('div');
        const reverseCheckbox = card.hasReverseHolo && selectedMode !== 'base' ? `
          <label class="flex items-center gap-1">
            <input type="checkbox" data-name="${card.name}" data-type="reverseHolo" ${reverseHolo ? 'checked' : ''}> Reverse Holo
          </label>
        ` : '';

        content.innerHTML = `
          <h2 class="font-bold text-lg">${card.name}</h2>
          <p class="text-sm text-gray-500">#${card.number} - ${card.rarity}</p>
          <div class="flex gap-4 mt-2">
            <label class="flex items-center gap-1">
              <input type="checkbox" data-name="${card.name}" data-type="standard" ${standard ? 'checked' : ''}> Standard
            </label>
            ${reverseCheckbox}
          </div>
        `;

        div.appendChild(img);
        div.appendChild(content);
        checklistContainer.appendChild(div);
      });

      document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', handleCheckboxChange);
      });
    }

    async function handleCheckboxChange(e) {
      const cb = e.target;
      const name = cb.dataset.name;
      const type = cb.dataset.type;
      const card = allCards.find(c => c.name === name);

      const standard = type === 'standard' ? cb.checked : document.querySelector(`input[data-name="${name}"][data-type="standard"]`)?.checked || false;
      const reverseHolo = type === 'reverseHolo' ? cb.checked : document.querySelector(`input[data-name="${name}"][data-type="reverseHolo"]`)?.checked || false;

      const updated = {
        name: card.name,
        number: card.number,
        rarity: card.rarity,
        standard,
        reverseHolo,
        hasReverseHolo: card.hasReverseHolo
      };

      localStorage.setItem(name, JSON.stringify(updated));
      showSaving(true);

      try {
        await fetch('/.netlify/functions/save-checklist', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updated)
        });
      } catch (err) {
        alert('Failed to save to Google Sheets.');
      } finally {
        showSaving(false);
        renderChecklist();
      }
    }

    async function fetchChecklist(set = currentSet) {
      showLoading(true);
      try {
        const res = await fetch(getApiUrl(set));
        const data = await res.json();
        allCards = data;
        buildRarityFilters(data);
        renderChecklist();
        localStorage.setItem('selectedSet', set);
      } catch (err) {
        console.error("Failed to fetch checklist:", err);
      } finally {
        showLoading(false);
      }
    }

    // Event Listeners
    setSelector.addEventListener('change', () => {
      currentSet = setSelector.value;
      fetchChecklist(currentSet);
    });

    sortDropdown.addEventListener('change', renderChecklist);
    hideCompletedCheckbox.addEventListener('change', renderChecklist);
    rarityFiltersContainer.addEventListener('change', renderChecklist);
    document.querySelectorAll('input[name="mode"]').forEach(rb =>
      rb.addEventListener('change', (e) => {
        selectedMode = e.target.value;
        renderChecklist();
      })
    );

    // Initial Load
    fetchChecklist(currentSet);
  </script>
</body>
</html>
