<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pok√©mon Card Checklist</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="sticky top-0 z-10 bg-white shadow p-4 space-y-2">
    <div class="flex items-center justify-between">
      <img id="setLogo" class="h-12" alt="Set Logo">
      <span id="progressText" class="text-sm font-medium text-blue-600"></span>
    </div>

    <div class="flex flex-wrap items-center gap-4 mt-2">
      <label>
        Set:
        <select id="setSelector" class="border p-1 rounded">
          <option value="JourneyTogether">Journey Together</option>
          <option value="TemporalForces">Temporal Forces</option>
          <option value="ObsidianFlames">Obsidian Flames</option>
          <option value="PrismaticEvolutions">Prismatic Evolutions</option>
        </select>
      </label>

      <label><input type="radio" name="mode" value="base" checked> Base Set</label>
      <label><input type="radio" name="mode" value="parallel"> Parallel Set</label>
      <label><input type="radio" name="mode" value="master"> Master Set</label>

      <label>Sort:
        <select id="sort" class="border p-1 rounded">
          <option value="number">Card Number</option>
          <option value="name">Name</option>
          <option value="rarity">Rarity</option>
        </select>
      </label>

      <label><input type="checkbox" id="hideCompleted"> Hide Collected</label>
      <span id="savingIndicator" class="text-sm text-blue-500 hidden">Saving...</span>
      <span id="loadingIndicator" class="text-sm text-gray-500 hidden">Loading...</span>
    </div>
  </div>

  <div id="checklist" class="grid grid-cols-1 sm:grid-cols-2 gap-4 p-4"></div>

  <script>
    const BASE_COUNTS = { JourneyTogether: 159, TemporalForces: 162, ObsidianFlames: 197, PrismaticEvolutions: 165 };
    const MASTER_COUNTS = { JourneyTogether: 190, TemporalForces: 218, ObsidianFlames: 230, PrismaticEvolutions: 200 };
    const SET_CODES = { JourneyTogether: 'sv9', TemporalForces: 'sv5', ObsidianFlames: 'sv3pt5', PrismaticEvolutions: 'sv8pt5' };
    const SET_LOGOS = {
      JourneyTogether: 'https://images.pokemontcg.io/sv9/logo.png',
      TemporalForces: 'https://images.pokemontcg.io/sv5/logo.png',
      ObsidianFlames: 'https://images.pokemontcg.io/sv3pt5/logo.png',
      PrismaticEvolutions: 'https://images.pokemontcg.io/sv8pt5/logo.png'
    };

    const checklistContainer = document.getElementById('checklist');
    const savingIndicator = document.getElementById('savingIndicator');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const progressText = document.getElementById('progressText');
    const setSelector = document.getElementById('setSelector');
    const sortDropdown = document.getElementById('sort');
    const hideCompletedCheckbox = document.getElementById('hideCompleted');
    const setLogo = document.getElementById('setLogo');

    let allCards = [], selectedMode = 'base', currentSet = setSelector.value;

    function getApiUrl(set) {
      return `/.netlify/functions/fetch-checklist?set=${set}`;
    }

    function getVariants(card, set) {
      const type = (card.type || '').toLowerCase();
      const rarity = (card.rarity || '').toLowerCase();

      if (type === 'trainer') return ['standard', 'reverseHolo', 'pokeball'];
      if (rarity === 'ace spec') return ['holo'];

      const base = [];
      const isCommon = rarity === 'common' || rarity === 'uncommon';
      const isRare = rarity === 'rare';

      if (isCommon) base.push('standard', 'reverseHolo');
      else if (isRare) base.push('holo', 'reverseHolo');
      else base.push('holo');

      if (set === 'PrismaticEvolutions') {
        if (isCommon || isRare) base.push('pokeball', 'masterball');
      }

      return base;
    }

    async function fetchChecklist(set = currentSet) {
      currentSet = set;
      setLogo.src = SET_LOGOS[set];
      showLoading(true);
      try {
        const res = await fetch(getApiUrl(set));
        const data = await res.json();
        allCards = data.map(card => ({ ...card, setCode: SET_CODES[set] }));
        renderChecklist();
      } catch (err) {
        console.error('Failed to fetch checklist:', err);
      } finally {
        showLoading(false);
      }
    }

    function renderChecklist() {
      const baseCount = BASE_COUNTS[currentSet];
      const masterCount = MASTER_COUNTS[currentSet];
      checklistContainer.innerHTML = '';
      let collected = 0;

      let cards = [...allCards].filter(card => parseInt(card.number) <= masterCount);
      if (hideCompletedCheckbox.checked) {
        cards = cards.filter(card => {
          const saved = JSON.parse(localStorage.getItem(card.name)) || {};
          const variants = getVariants(card, currentSet);
          return !variants.every(v => saved[v] || false);
        });
      }

      const sort = sortDropdown.value;
      if (sort === 'name') cards.sort((a, b) => a.name.localeCompare(b.name));
      else if (sort === 'rarity') cards.sort((a, b) => a.rarity.localeCompare(b.rarity));
      else cards.sort((a, b) => parseInt(a.number) - parseInt(b.number));

      for (const card of cards) {
        const saved = JSON.parse(localStorage.getItem(card.name)) || {};
        const variants = getVariants(card, currentSet);
        const number = parseInt(card.number);
        if (selectedMode === 'base' && number > baseCount) continue;

        const collectedVariants = variants.filter(v => saved[v]);
        if (
          (selectedMode === 'base' && collectedVariants.includes('standard')) ||
          (selectedMode === 'parallel' && (saved.standard || saved.reverseHolo || saved.holo)) ||
          (selectedMode === 'master' && collectedVariants.length > 0)
        ) collected++;

        const div = document.createElement('div');
        div.className = 'bg-white p-4 rounded-xl shadow flex gap-4';

        const img = document.createElement('img');
        img.src = `https://images.pokemontcg.io/${card.setCode}/${card.number}.png`;
        img.alt = card.name;
        img.className = 'w-24 h-auto';

        const content = document.createElement('div');
        content.innerHTML = `
          <h2 class="font-bold text-lg">${card.name}</h2>
          <p class="text-sm text-gray-500">#${card.number} - ${card.rarity}</p>
          <div class="flex flex-wrap gap-2 mt-2">
            ${variants.map(v => `
              <label class="flex items-center gap-1">
                <input type="checkbox" data-name="${card.name}" data-type="${v}" ${saved[v] ? 'checked' : ''}> ${v.replace(/([A-Z])/g, ' $1')}
              </label>`).join('')}
          </div>
        `;

        div.appendChild(img);
        div.appendChild(content);
        checklistContainer.appendChild(div);
      }

      const total = selectedMode === 'base' ? baseCount : masterCount;
      progressText.textContent = `${collected} / ${total}`;

      document.querySelectorAll('input[type="checkbox"]').forEach(cb =>
        cb.addEventListener('change', handleCheckboxChange)
      );
    }

    async function handleCheckboxChange(e) {
      const cb = e.target;
      const name = cb.dataset.name;
      const type = cb.dataset.type;
      const card = allCards.find(c => c.name === name);
      const saved = JSON.parse(localStorage.getItem(name)) || {};
      saved[type] = cb.checked;

      localStorage.setItem(name, JSON.stringify(saved));
      showSaving(true);
      try {
        await fetch('/.netlify/functions/save-checklist', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: card.name,
            number: card.number,
            rarity: card.rarity,
            type: card.type,
            ...saved
          })
        });
      } catch (err) {
        console.error('Save error:', err);
      } finally {
        showSaving(false);
        renderChecklist();
      }
    }

    function showSaving(show) {
      savingIndicator.classList.toggle('hidden', !show);
    }
    function showLoading(show) {
      loadingIndicator.classList.toggle('hidden', !show);
    }

    setSelector.addEventListener('change', () => fetchChecklist(setSelector.value));
    sortDropdown.addEventListener('change', renderChecklist);
    hideCompletedCheckbox.addEventListener('change', renderChecklist);
    document.querySelectorAll('input[name="mode"]').forEach(rb =>
      rb.addEventListener('change', e => { selectedMode = e.target.value; renderChecklist(); })
    );

    fetchChecklist(currentSet);
  </script>
</body>
</html>
