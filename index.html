<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Journey Together Checklist</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .saving-indicator {
      transition: opacity 0.3s ease;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-4xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Journey Together Set Checklist</h1>

    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 mb-4">
      <div class="flex items-center gap-2">
        <label for="sort" class="font-semibold">Sort by:</label>
        <select id="sort" class="border p-1 rounded">
          <option value="number">Card Number (asc)</option>
          <option value="name">Name (A-Z)</option>
          <option value="rarity">Rarity</option>
        </select>
      </div>

      <div class="flex items-center gap-2">
        <label for="hideCompleted" class="font-semibold">Hide Completed</label>
        <input type="checkbox" id="hideCompleted" />
      </div>

      <div class="relative">
        <button id="rarityFilterBtn" class="border px-3 py-1 rounded bg-white shadow">Filter by Rarity</button>
        <div id="rarityDropdown" class="absolute bg-white border rounded shadow mt-1 p-2 hidden z-10">
          <!-- checkboxes added dynamically -->
        </div>
      </div>

      <span id="savingIndicator" class="saving-indicator text-sm text-blue-600 hidden">Saving...</span>
    </div>

    <div id="checklist" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
  </div>

  <script>
    const API_URL = '/.netlify/functions/fetch-checklist';
    const SAVE_URL = '/.netlify/functions/save-checklist';
    const checklistContainer = document.getElementById('checklist');
    const savingIndicator = document.getElementById('savingIndicator');
    const rarityDropdown = document.getElementById('rarityDropdown');
    const rarityFilterBtn = document.getElementById('rarityFilterBtn');
    const selectedRarities = new Set();

    let cardData = [];

    async function fetchChecklist() {
      const res = await fetch(API_URL);
      const data = await res.json();
      cardData = data;
      buildRarityFilter(data);
      renderChecklist(data);
    }

    function buildRarityFilter(cards) {
      const rarities = Array.from(new Set(cards.map(c => c.rarity))).sort();
      rarityDropdown.innerHTML = '';
      rarities.forEach(rarity => {
        const id = `rarity-${rarity.replace(/\s+/g, '-')}`;
        const wrapper = document.createElement('div');
        wrapper.className = 'flex items-center gap-1';
        wrapper.innerHTML = `
          <input type="checkbox" id="${id}" data-rarity="${rarity}">
          <label for="${id}">${rarity}</label>
        `;
        rarityDropdown.appendChild(wrapper);
        wrapper.querySelector('input').addEventListener('change', () => {
          const checked = wrapper.querySelector('input').checked;
          if (checked) selectedRarities.add(rarity);
          else selectedRarities.delete(rarity);
          renderChecklist(cardData);
        });
      });
    }

    rarityFilterBtn.addEventListener('click', () => {
      rarityDropdown.classList.toggle('hidden');
    });

    function renderChecklist(cards) {
      checklistContainer.innerHTML = '';
      const hideCompleted = document.getElementById('hideCompleted').checked;

      cards.forEach(card => {
        const saved = JSON.parse(localStorage.getItem(card.name)) || {};
        const isStandard = saved.standard || card.standard;
        const isReverse = saved.reverseHolo || card.reverseHolo;

        if (hideCompleted && isStandard && (card.hasReverseHolo ? isReverse : true)) {
          return; // skip completed card
        }

        if (selectedRarities.size > 0 && !selectedRarities.has(card.rarity)) {
          return; // skip if not in selected rarities
        }

        const div = document.createElement('div');
        div.className = 'bg-white rounded-xl shadow p-4 flex gap-4 items-start';

        const img = document.createElement('img');
        img.src = `https://images.pokemontcg.io/sv9/${card.number}.png`;
        img.alt = card.name;
        img.className = 'w-24 h-auto rounded';

        const content = document.createElement('div');
        let reverseCheckbox = '';
        if (card.hasReverseHolo === true) {
          reverseCheckbox = `
            <label class="flex items-center gap-1">
              <input type="checkbox" ${isReverse ? 'checked' : ''} data-name="${card.name}" data-type="reverseHolo"> Reverse Holo
            </label>
          `;
        }

        content.innerHTML = `
          <h2 class="text-lg font-bold mb-1">${card.name}</h2>
          <p class="text-sm text-gray-500">#${card.number} - ${card.rarity}</p>
          <div class="mt-2 flex gap-4 items-center">
            <label class="flex items-center gap-1">
              <input type="checkbox" ${isStandard ? 'checked' : ''} data-name="${card.name}" data-type="standard"> Standard
            </label>
            ${reverseCheckbox}
          </div>
        `;

        div.appendChild(img);
        div.appendChild(content);
        checklistContainer.appendChild(div);
      });

      document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', handleCheckboxChange);
      });
    }

    function showSaving(show) {
      savingIndicator.classList.toggle('hidden', !show);
    }

    async function handleCheckboxChange(e) {
      const checkbox = e.target;
      const name = checkbox.dataset.name;
      const type = checkbox.dataset.type;
      const card = cardData.find(c => c.name === name);

      const updated = {
        name: card.name,
        number: card.number,
        rarity: card.rarity,
        standard: type === 'standard' ? checkbox.checked : document.querySelector(`input[data-name="${name}"][data-type="standard"]`)?.checked || false,
        reverseHolo: type === 'reverseHolo' ? checkbox.checked : document.querySelector(`input[data-name="${name}"][data-type="reverseHolo"]`)?.checked || false
      };

      localStorage.setItem(name, JSON.stringify(updated));
      showSaving(true);

      try {
        await fetch(SAVE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updated)
        });
      } catch (err) {
        alert('Failed to save to Google Sheets.');
        console.error(err);
      } finally {
        showSaving(false);
        renderChecklist(cardData);
      }
    }

    document.getElementById('sort').addEventListener('change', e => {
      const sortBy = e.target.value;
      const sorted = [...cardData];
      if (sortBy === 'number') {
        sorted.sort((a, b) => parseInt(a.number) - parseInt(b.number));
      } else if (sortBy === 'name') {
        sorted.sort((a, b) => a.name.localeCompare(b.name));
      } else if (sortBy === 'rarity') {
        sorted.sort((a, b) => a.rarity.localeCompare(b.rarity));
      }
      renderChecklist(sorted);
    });

    document.getElementById('hideCompleted').addEventListener('change', () => {
      renderChecklist(cardData);
    });

    fetchChecklist();
  </script>
</body>
</html>
