<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pok√©mon Card Checklist</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="sticky top-0 z-10 bg-white shadow p-4 space-y-2">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <img id="setLogo" class="h-12" alt="Set Logo">
      </div>
      <span id="progressText" class="text-sm font-medium text-blue-600"></span>
    </div>

    <div class="flex flex-wrap items-center gap-4 mt-2">
      <label>
        Set:
        <select id="setSelector" class="border p-1 rounded"></select>
      </label>

      <label><input type="radio" name="mode" value="base" checked> Base Set</label>
      <label><input type="radio" name="mode" value="parallel"> Parallel Set</label>
      <label><input type="radio" name="mode" value="master"> Master Set</label>

      <label><input type="checkbox" id="hideCompleted"> Hide Collected</label>
      <span id="savingIndicator" class="text-sm text-blue-500 hidden">Saving...</span>
      <span id="loadingIndicator" class="text-sm text-gray-500 hidden">Loading...</span>
    </div>
  </div>

  <div id="checklist" class="grid grid-cols-1 sm:grid-cols-2 gap-4 p-4"></div>

  <script>
    let SET_METADATA = {};
    let allCards = [];
    let selectedMode = 'base';
    let currentSet = '';

    const checklistContainer = document.getElementById('checklist');
    const savingIndicator = document.getElementById('savingIndicator');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const progressText = document.getElementById('progressText');
    const setSelector = document.getElementById('setSelector');
    const setLogo = document.getElementById('setLogo');
    const hideCompletedCheckbox = document.getElementById('hideCompleted');

    function showSaving(show) {
      savingIndicator.classList.toggle('hidden', !show);
    }
    function showLoading(show) {
      loadingIndicator.classList.toggle('hidden', !show);
    }

    async function fetchSetMetadata() {
      const res = await fetch('/.netlify/functions/fetch-checklist?set=Sets');
      const sets = await res.json();
      SET_METADATA = {};
      setSelector.innerHTML = '';
      sets.forEach(set => {
        SET_METADATA[set.setName] = {
          base: parseInt(set.baseCount),
          master: parseInt(set.masterCount),
          code: set.setCode,
          logo: set.logoURL
        };
        const opt = document.createElement('option');
        opt.value = set.setName;
        opt.textContent = set.setName.replace(/([a-z])([A-Z])/g, '$1 $2');
        setSelector.appendChild(opt);
      });
      currentSet = setSelector.value;
    }

    async function fetchChecklist(setName) {
      currentSet = setName;
      showLoading(true);
      const res = await fetch(`/.netlify/functions/fetch-checklist?set=${setName}`);
      const data = await res.json();
      allCards = data.map(c => ({ ...c, setCode: SET_METADATA[setName]?.code }));
      setLogo.src = SET_METADATA[setName]?.logo || '';
      renderChecklist();
      showLoading(false);
    }

    function renderChecklist() {
      checklistContainer.innerHTML = '';
      const baseCount = SET_METADATA[currentSet]?.base || 0;
      const masterCount = SET_METADATA[currentSet]?.master || 0;
      let collected = 0;

      allCards.forEach(card => {
        const number = parseInt(card.number);
        if (selectedMode === 'base' && number > baseCount) return;
        if (selectedMode === 'parallel' && number > baseCount) return;
        if (selectedMode === 'master' && number > masterCount) return;

        const saved = JSON.parse(localStorage.getItem(card.name)) || {};
        const isCollected = saved.standard || saved.reverseHolo || saved.holoFoil || saved.pokeball || saved.masterball;
        if (hideCompletedCheckbox.checked && isCollected) return;

        if (isCollected) collected++;

        const div = document.createElement('div');
        div.className = 'bg-white p-4 rounded-xl shadow flex gap-4';

        const img = document.createElement('img');
        img.src = `https://images.pokemontcg.io/${card.setCode}/${card.number}.png`;
        img.alt = card.name;
        img.className = 'w-24 h-auto';

        const content = document.createElement('div');
        const checkboxVariants = [];

        const rarity = (card.rarity || '').toLowerCase();
        const type = (card.type || '').toLowerCase();

        if (type === 'trainer') {
          checkboxVariants.push('standard', 'reverseHolo', 'pokeball');
        } else if (rarity === 'ace spec') {
          checkboxVariants.push('holoFoil');
        } else if (rarity === 'common' || rarity === 'uncommon') {
          checkboxVariants.push('standard', 'reverseHolo');
          if (currentSet === 'PrismaticEvolutions') checkboxVariants.push('pokeball', 'masterball');
        } else if (rarity === 'rare' || rarity === 'double rare') {
          checkboxVariants.push('holoFoil', 'reverseHolo');
          if (currentSet === 'PrismaticEvolutions') checkboxVariants.push('pokeball', 'masterball');
        } else {
          checkboxVariants.push('holoFoil');
        }

        const checkboxes = checkboxVariants.map(variant => {
          const checked = saved[variant] ?? card[variant];
          return `<label class="flex items-center gap-1">
            <input type="checkbox" data-name="${card.name}" data-type="${variant}" ${checked ? 'checked' : ''}> ${variant}
          </label>`;
        }).join('');

        content.innerHTML = `
          <h2 class="font-bold text-lg">${card.name}</h2>
          <p class="text-sm text-gray-500">#${card.number} - ${card.rarity}</p>
          <div class="flex flex-wrap gap-2 mt-2">${checkboxes}</div>
        `;

        div.appendChild(img);
        div.appendChild(content);
        checklistContainer.appendChild(div);
      });

      const total = selectedMode === 'base' ? SET_METADATA[currentSet]?.base
                   : selectedMode === 'parallel' ? SET_METADATA[currentSet]?.base * 2
                   : SET_METADATA[currentSet]?.master;

      progressText.textContent = `${collected} / ${total}`;

      document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', handleCheckboxChange);
      });
    }

    async function handleCheckboxChange(e) {
      const cb = e.target;
      const name = cb.dataset.name;
      const type = cb.dataset.type;
      const card = allCards.find(c => c.name === name);

      const saved = JSON.parse(localStorage.getItem(name)) || {};
      saved[type] = cb.checked;
      localStorage.setItem(name, JSON.stringify(saved));

      const updated = {
        name: card.name,
        number: card.number,
        rarity: card.rarity,
        type: card.type,
        ...saved
      };

      showSaving(true);
      try {
        await fetch('/.netlify/functions/save-checklist', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...updated, sheet: currentSet })
        });
      } catch (err) {
        console.error(err);
        alert('Save failed');
      } finally {
        showSaving(false);
        renderChecklist();
      }
    }

    // Init
    document.querySelectorAll('input[name="mode"]').forEach(rb => rb.addEventListener('change', e => {
      selectedMode = e.target.value;
      renderChecklist();
    }));
    setSelector.addEventListener('change', () => fetchChecklist(setSelector.value));
    hideCompletedCheckbox.addEventListener('change', renderChecklist);

    fetchSetMetadata().then(() => fetchChecklist(setSelector.value));
  </script>
</body>
</html>
