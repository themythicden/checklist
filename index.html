<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Journey Together Checklist</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .saving-indicator {
      transition: opacity 0.3s ease;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-4xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Journey Together Set Checklist</h1>

    <div class="flex items-center gap-4 mb-4">
      <label for="sort" class="font-semibold">Sort by:</label>
      <select id="sort" class="border p-1 rounded">
        <option value="number">Card Number (asc)</option>
        <option value="name">Name (A-Z)</option>
        <option value="rarity">Rarity</option>
      </select>
      <span id="savingIndicator" class="saving-indicator text-sm text-blue-600 hidden">Saving...</span>
    </div>

    <div id="checklist" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
  </div>

  <script>
    const API_URL = '/.netlify/functions/fetch-checklist';
    const SAVE_URL = '/.netlify/functions/save-checklist';
    const checklistContainer = document.getElementById('checklist');
    const savingIndicator = document.getElementById('savingIndicator');

    let cardData = [];

    async function fetchChecklist() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        cardData = data;
        renderChecklist(data);
      } catch (err) {
        console.error('Failed to load checklist:', err);
        checklistContainer.innerHTML = "<p class='text-red-600'>Failed to load checklist.</p>";
      }
    }

    function renderChecklist(cards) {
      checklistContainer.innerHTML = '';
      cards.forEach(card => {
        const cardId = encodeURIComponent(card.name);
        const saved = JSON.parse(localStorage.getItem(cardId)) || {};

        const div = document.createElement('div');
        div.className = 'bg-white rounded-xl shadow p-4 flex gap-4 items-start';

        const img = document.createElement('img');
        img.src = `https://images.pokemontcg.io/sv9/${card.number}.png`;
        img.alt = card.name;
        img.className = 'w-24 h-auto rounded';

        const content = document.createElement('div');

        // Checkboxes
        let reverseCheckbox = '';
        if (card.reverseHolo !== null && card.reverseHolo !== false && card.hasReverseHolo !== true) {
          reverseCheckbox = `
            <label class="flex items-center gap-1">
              <input type="checkbox" ${saved.reverseHolo || card.reverseHolo ? 'checked' : ''} data-name="${card.name}" data-type="reverseHolo"> Reverse Holo
            </label>
          `;
        }

        content.innerHTML = `
          <h2 class="text-lg font-bold mb-1">${card.name}</h2>
          <p class="text-sm text-gray-500">#${card.number} - ${card.rarity}</p>
          <div class="mt-2 flex gap-4 items-center">
            <label class="flex items-center gap-1">
              <input type="checkbox" ${saved.standard || card.standard ? 'checked' : ''} data-name="${card.name}" data-type="standard"> Standard
            </label>
            ${reverseCheckbox}
          </div>
        `;

        div.appendChild(img);
        div.appendChild(content);
        checklistContainer.appendChild(div);
      });

      document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', handleCheckboxChange);
      });
    }

    function showSaving(show) {
      savingIndicator.classList.toggle('hidden', !show);
    }

    async function handleCheckboxChange(e) {
      const checkbox = e.target;
      const name = checkbox.dataset.name;
      const type = checkbox.dataset.type;
      const card = cardData.find(c => c.name === name);

      const updated = {
        name: card.name,
        number: card.number,
        rarity: card.rarity,
        standard: type === 'standard' ? checkbox.checked : document.querySelector(`input[data-name="${name}"][data-type="standard"]`)?.checked || false,
        reverseHolo: type === 'reverseHolo' ? checkbox.checked : document.querySelector(`input[data-name="${name}"][data-type="reverseHolo"]`)?.checked || false
      };

      localStorage.setItem(name, JSON.stringify(updated));
      showSaving(true);

      try {
        await fetch(SAVE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updated)
        });
      } catch (err) {
        alert('Failed to save to Google Sheets.');
        console.error(err);
      } finally {
        showSaving(false);
      }
    }

    document.getElementById('sort').addEventListener('change', e => {
      const sortBy = e.target.value;
      const sorted = [...cardData];
      if (sortBy === 'number') {
        sorted.sort((a, b) => (a.number || '').localeCompare(b.number || '', undefined, { numeric: true }));
      } else if (sortBy === 'name') {
        sorted.sort((a, b) => a.name.localeCompare(b.name));
      } else if (sortBy === 'rarity') {
        sorted.sort((a, b) => (a.rarity || '').localeCompare(b.rarity || ''));
      }
      renderChecklist(sorted);
    });

    fetchChecklist();
  </script>
</body>
</html>
